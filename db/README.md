# Database Migration Setup - Drizzle ORM

This directory contains the Drizzle ORM setup for migrating from Supabase to local PostgreSQL.

## Directory Structure

```
db/
├── migrate/                    # Generated migration files
│   ├── 0000_moaning_gladiator.sql  # Tables and indexes (auto-generated)
│   ├── 0001_extensions.sql         # PostgreSQL extensions
│   ├── 0002_triggers.sql           # Triggers and utility functions
│   └── 0003_functions.sql          # Application database functions
├── seed/                       # Database seeding files
│   ├── seed-notes.ts              # Note seeding script
│   └── entrepreneur-notes.json    # Sample note data
├── schema.ts                   # Drizzle schema definition
├── connection.ts               # Database connection utilities
├── migrate-runner.ts           # Custom migration runner
├── truncate.ts                 # Database truncation utility
└── README.md                   # This file
```

## Migration Files

### 0000_moaning_gladiator.sql

Auto-generated by Drizzle Kit. Contains:

-   `notes` table creation with all columns
-   All indexes (standard, GIN arrays, vector similarity)

### 0001_extensions.sql

PostgreSQL extensions setup:

-   `vector` extension for pgvector (semantic search)

### 0002_triggers.sql

Triggers and utility functions:

-   `update_updated_at_column()` function
-   `set_updated_at` trigger for automatic timestamp updates

### 0003_functions.sql

Application database functions:

-   `get_user_context_stats()` - Basic context statistics
-   `get_user_context_stats_paginated()` - Paginated context stats with search
-   `search_user_contexts()` - Context search functionality
-   `search_notes_by_similarity()` - Semantic search using embeddings

## Usage

### Prerequisites

1. **PostgreSQL with pgvector extension installed**

    ```bash
    # macOS with Homebrew
    brew install postgresql pgvector

    # Or using Docker Compose (recommended for development)
    cd docker && docker-compose up -d

    # Or manual Docker setup
    docker run -d \
      --name hathi-postgres \
      -p 5432:5432 \
      -e POSTGRES_PASSWORD=hathi-db-1234% \
      -e POSTGRES_DB=postgres \
      pgvector/pgvector:pg16
    ```

2. **Environment variables in .env.local**

    ```env
    POSTGRES_HOST=localhost
    POSTGRES_PORT=5432
    POSTGRES_USER=postgres
    POSTGRES_PASSWORD=hathi-db-123!
    POSTGRES_DB=hathi_db

    # Required for seeding (AI embeddings)
    GOOGLE_AI_API_KEY=your-google-api-key
    ```

### Available Scripts

```bash
# Test database connection
yarn db:test

# Run all migrations
yarn db:migrate

# Reset database (drop all tables and re-run migrations)
yarn db:reset

# Generate new migration from schema changes
yarn db:generate

# Data management commands
yarn db:truncate    # Remove all data (keep schema)
yarn db:seed        # Populate with sample data
yarn db:fresh       # Truncate + seed (quick refresh)

# Database inspection commands
yarn db:tables      # List all tables
yarn db:schema      # Show table schemas
yarn db:functions   # List database functions
yarn db:indexes     # Show all indexes
yarn db:data        # Show table data (requires table name)
yarn db:overview    # Database overview
```

### Migration Process

1. **Test Connection**

    ```bash
    yarn db:test
    ```

2. **Run Migrations**

    ```bash
    yarn db:migrate
    ```

3. **For Fresh Install (or Reset)**
    ```bash
    yarn db:reset
    ```

### Data Management

**Quick Development Setup (Most Common)**

```bash
# Get fresh sample data for development
yarn db:fresh
```

**Individual Data Commands**

```bash
# Remove all data but keep schema
yarn db:truncate

# Add sample entrepreneur notes (20 notes across past 7 days)
yarn db:seed
```

The seeding process:

-   Creates 20 realistic entrepreneur notes
-   Distributes them across the past 7 days
-   Generates AI embeddings for semantic search
-   Includes contexts, tags, and note types for testing filters

## Schema Management

The database schema is defined in `schema.ts` using Drizzle ORM. This file defines:

-   Table structure
-   Column types and constraints
-   Indexes and their configurations
-   TypeScript types for the application

### Adding New Columns

1. Update `schema.ts` with new columns
2. Generate migration: `yarn db:generate`
3. Review the generated SQL file
4. Run migration: `yarn db:migrate`

## Migration Runner Features

The custom migration runner (`migrate-runner.ts`) provides:

-   **Ordered execution** - Runs migration files in numerical order
-   **Error handling** - Stops on first error with detailed logging
-   **Connection testing** - Verifies database connectivity before migration
-   **Reset functionality** - Clean slate database setup
-   **Detailed logging** - Shows progress and success/failure for each step

## Data Management Features

### Truncation (`truncate.ts`)

-   **Safe data removal** - Removes all data while preserving schema
-   **RESTART IDENTITY** - Resets auto-increment sequences
-   **CASCADE handling** - Properly handles foreign key constraints
-   **Connection management** - Automatic cleanup and error handling

### Seeding (`seed/seed-notes.ts`)

-   **Realistic data** - 20 entrepreneur-focused notes with authentic content
-   **Time distribution** - Notes spread across past 7 days with random timestamps
-   **AI embeddings** - Generates vector embeddings for semantic search testing
-   **Rich metadata** - Includes contexts, tags, note types for comprehensive testing
-   **Batch processing** - Efficient bulk operations for better performance

## Schema Compatibility

This migration setup perfectly replicates the current Supabase schema:

✅ **Tables**: `notes` table with all required columns  
✅ **Indexes**: All performance indexes (B-tree, GIN, IVFFlat)  
✅ **Functions**: All application database functions  
✅ **Triggers**: Automatic timestamp updates  
✅ **Extensions**: pgvector for semantic search  
✅ **No Auth**: User authentication completely removed

## Next Steps

After successful migration setup:

1. **Development workflow**: Use `yarn db:fresh` for quick data refresh during development
2. **Application integration**: Update server actions to use Drizzle ORM instead of Supabase client
3. **Testing**: Use seeded data to test filtering, search, and other application features
4. **Production deployment**: Deploy PostgreSQL with pgvector to production environment
5. **Data migration**: Import existing production data from Supabase to PostgreSQL

## Common Development Tasks

```bash
# Fresh start for development
yarn db:fresh

# Schema changes workflow
yarn db:generate    # After updating schema.ts
yarn db:migrate     # Apply the changes

# Clean slate (nuclear option)
yarn db:reset
yarn db:seed

# Production-like testing
yarn db:truncate
# Import real data here
```
