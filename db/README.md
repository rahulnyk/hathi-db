# Database Migration Setup - Drizzle ORM

This directory contains the Drizzle ORM setup for migrating from Supabase to local PostgreSQL.

## Directory Structure

```
db/
├── migrate/                    # Generated migration files
│   ├── 0000_moaning_gladiator.sql  # Tables and indexes (auto-generated)
│   ├── 0001_extensions.sql         # PostgreSQL extensions
│   ├── 0002_triggers.sql           # Triggers and utility functions
│   └── 0003_functions.sql          # Application database functions
├── schema.ts                   # Drizzle schema definition
├── connection.ts               # Database connection utilities
├── migrate-runner.ts           # Custom migration runner
└── README.md                   # This file
```

## Migration Files

### 0000_moaning_gladiator.sql

Auto-generated by Drizzle Kit. Contains:

-   `notes` table creation with all columns
-   All indexes (standard, GIN arrays, vector similarity)

### 0001_extensions.sql

PostgreSQL extensions setup:

-   `vector` extension for pgvector (semantic search)

### 0002_triggers.sql

Triggers and utility functions:

-   `update_updated_at_column()` function
-   `set_updated_at` trigger for automatic timestamp updates

### 0003_functions.sql

Application database functions:

-   `get_user_context_stats()` - Basic context statistics
-   `get_user_context_stats_paginated()` - Paginated context stats with search
-   `search_user_contexts()` - Context search functionality
-   `search_notes_by_similarity()` - Semantic search using embeddings

## Usage

### Prerequisites

1. **PostgreSQL with pgvector extension installed**

    ```bash
    # macOS with Homebrew
    brew install postgresql pgvector

    # Or using Docker Compose (recommended for development)
    cd docker && docker-compose up -d

    # Or manual Docker setup
    docker run -d \
      --name hathi-postgres \
      -p 5432:5432 \
      -e POSTGRES_PASSWORD=hathi-db-1234% \
      -e POSTGRES_DB=postgres \
      pgvector/pgvector:pg16
    ```

2. **Environment variables in .env.local**
    ```env
    POSTGRES_HOST=localhost
    POSTGRES_PORT=5432
    POSTGRES_USER=postgres
    POSTGRES_PASSWORD=hathi-db-1234%
    POSTGRES_DB=postgres
    ```

### Available Scripts

```bash
# Test database connection
yarn db:test

# Run all migrations
yarn db:migrate

# Reset database (drop all tables and re-run migrations)
yarn db:reset

# Generate new migration from schema changes
yarn db:generate
```

### Migration Process

1. **Test Connection**

    ```bash
    yarn db:test
    ```

2. **Run Migrations**

    ```bash
    yarn db:migrate
    ```

3. **For Fresh Install (or Reset)**
    ```bash
    yarn db:reset
    ```

## Schema Management

The database schema is defined in `schema.ts` using Drizzle ORM. This file defines:

-   Table structure
-   Column types and constraints
-   Indexes and their configurations
-   TypeScript types for the application

### Adding New Columns

1. Update `schema.ts` with new columns
2. Generate migration: `yarn db:generate`
3. Review the generated SQL file
4. Run migration: `yarn db:migrate`

## Migration Runner Features

The custom migration runner (`migrate-runner.ts`) provides:

-   **Ordered execution** - Runs migration files in numerical order
-   **Error handling** - Stops on first error with detailed logging
-   **Connection testing** - Verifies database connectivity before migration
-   **Reset functionality** - Clean slate database setup
-   **Detailed logging** - Shows progress and success/failure for each step

## Schema Compatibility

This migration setup perfectly replicates the current Supabase schema:

✅ **Tables**: `notes` table with all required columns  
✅ **Indexes**: All performance indexes (B-tree, GIN, IVFFlat)  
✅ **Functions**: All application database functions  
✅ **Triggers**: Automatic timestamp updates  
✅ **Extensions**: pgvector for semantic search  
✅ **No Auth**: User authentication completely removed

## Next Steps

After successful migration setup:

1. Update application database client to use local PostgreSQL
2. Update server actions to use Drizzle ORM instead of Supabase client
3. Test all application functionality with local database
4. Deploy local PostgreSQL to production environment
